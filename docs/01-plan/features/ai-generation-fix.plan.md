# Plan Document: AI 인사이트/전략 생성 오류 수정

**Feature**: ai-generation-fix
**Created**: 2026-02-12
**Level**: Dynamic
**Priority**: Critical (서비스 핵심 기능 장애)

---

## 1. 문제 정의

### 1.1 현상

AI 인사이트 및 전략 생성이 실패하거나 의미 없는 결과를 반환함.

### 1.2 영향 범위

| 기능 | 영향도 | 현상 |
|------|--------|------|
| 일일 자동 인사이트 생성 | **Critical** | 빈 데이터로 AI 호출, 제네릭한 결과 |
| 캠페인 레벨 인사이트 | **High** | topCreatives 누락 |
| 수동 인사이트 생성 | Medium | 정상 동작 중 |
| 전략 생성 | **High** | 인사이트 기반 전략 품질 저하 |

---

## 2. 근본 원인 분석

### 2.1 Critical Issues

#### Issue #1: Daily Insights Job에서 빈 데이터 전달

**위치**: `/api/jobs/daily-insights/route.ts` (Lines 161-163)

```typescript
// 현재 코드 - 빈 배열 전달
trend: [],
topCreatives: [],
campaigns: [],
```

**문제**: AI가 context 없이 분석을 시도하여 제네릭한 인사이트 생성

#### Issue #2: Campaign Insight Route에서 topCreatives 누락

**위치**: `/api/ai/insights/[accountId]/campaigns/[campaignId]/generate/route.ts`

```typescript
// 현재 코드 - topCreatives 빈 배열
topCreatives: [],
```

**문제**: 캠페인 레벨 크리에이티브 분석 불가

#### Issue #3: OpenAI Client Timeout 미설정

**위치**: `/lib/ai/client.ts`

**문제**: Vercel Function timeout (10초/60초) 초과 가능성

#### Issue #4: Retry 로직 부재

**위치**: `generateCompletion()` 함수

**문제**: Rate limit 또는 일시적 오류 시 즉시 실패

---

## 3. 해결 방안

### 3.1 Phase 1: Data Flow 수정 (Critical)

| ID | 항목 | 설명 | 파일 |
|----|------|------|------|
| P1-01 | Daily Job trend 데이터 조회 | 7일간 일별 메트릭 조회 추가 | `daily-insights/route.ts` |
| P1-02 | Daily Job topCreatives 조회 | 상위 5개 크리에이티브 조회 | `daily-insights/route.ts` |
| P1-03 | Daily Job campaigns 조회 | 활성 캠페인 5개 조회 | `daily-insights/route.ts` |
| P1-04 | Campaign insight topCreatives | 캠페인별 크리에이티브 조회 | `campaigns/.../generate/route.ts` |

### 3.2 Phase 2: Client Stability (High)

| ID | 항목 | 설명 | 파일 |
|----|------|------|------|
| P2-01 | OpenAI timeout 설정 | 30초 timeout 설정 | `lib/ai/client.ts` |
| P2-02 | Retry 로직 추가 | 3회 재시도 with exponential backoff | `lib/ai/client.ts` |
| P2-03 | Error 상세 로깅 | 실패 원인 추적 로그 | `lib/ai/client.ts` |

### 3.3 Phase 3: Validation 강화 (Medium)

| ID | 항목 | 설명 | 파일 |
|----|------|------|------|
| P3-01 | Data validation | AI 호출 전 데이터 검증 | 각 route 파일 |
| P3-02 | Fallback 개선 | 더 유용한 rule-based fallback | `lib/ai/fallback.ts` |

---

## 4. 구현 우선순위

```
┌─────────────────────────────────────────────────────┐
│ Phase 1: Data Flow (Critical)        예상 효과: 80% │
├─────────────────────────────────────────────────────┤
│ • P1-01~04: AI에 실제 데이터 전달                   │
│ • 인사이트 품질 즉시 개선                            │
└─────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────┐
│ Phase 2: Stability (High)            예상 효과: 15% │
├─────────────────────────────────────────────────────┤
│ • P2-01~03: 안정성 및 복원력 향상                   │
│ • 일시적 오류 자동 복구                              │
└─────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────┐
│ Phase 3: Validation (Medium)         예상 효과: 5%  │
├─────────────────────────────────────────────────────┤
│ • P3-01~02: 예외 상황 처리 강화                     │
└─────────────────────────────────────────────────────┘
```

---

## 5. 성공 기준

### 5.1 기능적 기준

| ID | 기준 | 검증 방법 |
|----|------|-----------|
| SC-01 | Daily Job이 실제 데이터로 AI 호출 | 로그 확인, 인사이트 내용 검토 |
| SC-02 | 캠페인 인사이트에 크리에이티브 분석 포함 | API 응답 확인 |
| SC-03 | AI 호출 실패 시 자동 재시도 | 의도적 실패 테스트 |
| SC-04 | Fallback 시 유용한 인사이트 생성 | OPENAI_API_KEY 제거 후 테스트 |

### 5.2 품질 기준

| ID | 기준 | 목표 |
|----|------|------|
| QC-01 | AI 인사이트 생성 성공률 | > 95% |
| QC-02 | 인사이트 품질 (keyFindings 개수) | 평균 3개 이상 |
| QC-03 | 응답 시간 | < 30초 |

---

## 6. 리스크 및 완화 방안

| 리스크 | 영향 | 완화 방안 |
|--------|------|-----------|
| OpenAI API 비용 증가 | Medium | 캐싱, 요청 최적화 |
| Vercel Function Timeout | High | timeout 설정, 데이터 크기 제한 |
| DB 쿼리 성능 | Medium | 인덱스 확인, 쿼리 최적화 |

---

## 7. 참고 파일

### 수정 대상

```
src/app/api/jobs/daily-insights/route.ts      # Critical
src/app/api/ai/insights/[accountId]/campaigns/[campaignId]/generate/route.ts
src/lib/ai/client.ts                          # High
src/lib/ai/fallback.ts                        # Medium
```

### 참조 파일

```
src/lib/ai/modules/insight-generator.ts
src/lib/ai/modules/strategy-advisor.ts
src/lib/ai/prompts/insight.ts
src/lib/ai/schemas/insight.schema.ts
```

---

*Generated by bkit PDCA workflow*

# Plan: 시스템 개선 v1

## 개요

| 항목 | 내용 |
|------|------|
| **기능명** | system-improvement-v1 |
| **작성일** | 2026-02-19 |
| **목표** | 코드 품질 점수 72점 → 90점 향상 |
| **우선순위** | HIGH |
| **예상 범위** | 15+ 파일 수정 |

---

## 현재 상태 분석

### 종합 품질 점수: 72/100

| 영역 | 현재 점수 | 목표 점수 | Gap |
|------|:--------:|:--------:|:---:|
| API 보안 | 50 | 90 | 40 |
| AI 효율성 | 65 | 85 | 20 |
| DB 성능 | 70 | 90 | 20 |
| 프론트엔드 | 75 | 85 | 10 |
| 코드 품질 | 80 | 90 | 10 |

---

## Phase 1: API 보안 강화 (HIGH)

### 1.1 입력 검증 미들웨어

**현재 문제**:
```typescript
// 현재: try-catch로만 처리
let type = 'DAILY_SUMMARY';
try {
  const body = await request.json();
  type = body.type || 'DAILY_SUMMARY';
} catch {
  // Body is empty or invalid
}
```

**개선 목표**:
- Zod 스키마 기반 입력 검증
- 일관된 에러 응답 형식
- 타입 안전성 확보

**구현 파일**:
| 파일 | 작업 |
|------|------|
| `src/lib/api/validation.ts` | 신규 - 검증 유틸리티 |
| `src/lib/api/schemas.ts` | 신규 - Zod 스키마 정의 |
| `src/app/api/ai/insights/*/route.ts` | 수정 - 검증 적용 |
| `src/app/api/ai/strategies/*/route.ts` | 수정 - 검증 적용 |

### 1.2 인증 미들웨어

**현재 문제**:
- 계정 소유권 확인 없이 바로 데이터 접근
- 세션 검증 누락

**개선 목표**:
- 계정 접근 권한 검증
- 세션 기반 인증 확인

**구현 파일**:
| 파일 | 작업 |
|------|------|
| `src/lib/api/auth.ts` | 신규 - 인증 유틸리티 |
| `src/app/api/accounts/[accountId]/*` | 수정 - 인증 적용 |

### 1.3 Rate Limiting

**현재 문제**:
- AI API 무제한 호출 가능
- 남용 방지 메커니즘 없음

**개선 목표**:
- AI 엔드포인트 분당 5회 제한
- IP/사용자 기반 Rate Limiting

**구현 파일**:
| 파일 | 작업 |
|------|------|
| `src/lib/api/rate-limit.ts` | 신규 - Rate Limiter |
| `src/app/api/ai/*/route.ts` | 수정 - Rate Limit 적용 |

---

## Phase 2: AI 비용 최적화 (HIGH)

### 2.1 프롬프트 템플릿 통합

**현재 문제**:
- 각 함수에 인라인 프롬프트 중복
- 유지보수 어려움

**개선 목표**:
- 중앙 집중화된 프롬프트 관리
- 버전 관리 가능

**구현 파일**:
| 파일 | 작업 |
|------|------|
| `src/lib/ai/prompts/templates.ts` | 신규 - 통합 템플릿 |
| `src/lib/ai/modules/*.ts` | 수정 - 템플릿 참조 |

### 2.2 모델 선택 최적화

**현재 문제**:
- 모든 작업에 `gpt-4o` 사용
- 불필요한 비용 발생

**개선 목표**:
- 복잡도별 모델 선택
- 간단한 작업: `gpt-4o-mini`
- 복잡한 전략: `gpt-4o`

**비용 절감 예상**: 40-50%

**구현 파일**:
| 파일 | 작업 |
|------|------|
| `src/lib/ai/client.ts` | 수정 - 모델 선택 로직 |
| `src/lib/ai/config.ts` | 신규 - 모델 설정 |

### 2.3 AI 응답 캐싱

**현재 문제**:
- 동일 데이터에 대한 반복 AI 호출
- 캐싱 없음

**개선 목표**:
- 6시간 캐시 (동일 계정/기간)
- DB 기반 캐싱

**구현 파일**:
| 파일 | 작업 |
|------|------|
| `src/lib/ai/cache.ts` | 신규 - 캐시 로직 |
| `src/app/api/ai/insights/*/route.ts` | 수정 - 캐시 적용 |

### 2.4 Fallback 로직 활성화

**현재 문제**:
- `isOpenAIAvailable()` 체크 미사용
- API 실패 시 에러만 반환

**개선 목표**:
- API 불가 시 규칙 기반 분석 제공
- 사용자 경험 유지

**구현 파일**:
| 파일 | 작업 |
|------|------|
| `src/app/api/ai/insights/*/route.ts` | 수정 - Fallback 적용 |
| `src/app/api/ai/strategies/*/route.ts` | 수정 - Fallback 적용 |

---

## Phase 3: DB 성능 최적화 (MEDIUM)

### 3.1 복합 인덱스 추가

**현재 문제**:
- 단일 컬럼 인덱스만 존재
- 레벨별 조회 시 Full Scan

**개선 목표**:
- `(accountId, level, date)` 복합 인덱스
- 조회 성능 50% 이상 개선

**구현 파일**:
| 파일 | 작업 |
|------|------|
| `prisma/schema.prisma` | 수정 - 인덱스 추가 |
| 마이그레이션 | 실행 |

### 3.2 토큰 암호화

**현재 문제**:
- OAuth 토큰 평문 저장
- 보안 위험

**개선 목표**:
- AES-256 암호화 적용
- 환경 변수 기반 키 관리

**구현 파일**:
| 파일 | 작업 |
|------|------|
| `src/lib/crypto.ts` | 신규 - 암호화 모듈 |
| `src/lib/tiktok/auth.ts` | 수정 - 암호화 적용 |

### 3.3 소프트 삭제 구현

**현재 문제**:
- 물리 삭제만 지원
- 데이터 복구 불가

**개선 목표**:
- `deletedAt` 필드 추가
- 삭제 대신 마킹

**구현 파일**:
| 파일 | 작업 |
|------|------|
| `prisma/schema.prisma` | 수정 - deletedAt 추가 |
| `src/lib/db/prisma.ts` | 수정 - 미들웨어 추가 |

---

## Phase 4: 프론트엔드 개선 (MEDIUM)

### 4.1 중복 API 호출 제거

**현재 문제**:
- 캠페인 + 계정 정보 별도 호출
- 불필요한 네트워크 요청

**개선 목표**:
- React Query 도입
- 데이터 캐싱 및 재사용

**구현 파일**:
| 파일 | 작업 |
|------|------|
| `package.json` | 수정 - @tanstack/react-query 추가 |
| `src/lib/hooks/useQueries.ts` | 신규 - 커스텀 훅 |
| `src/app/(dashboard)/accounts/[accountId]/page.tsx` | 수정 |

### 4.2 타입 안전성 강화

**현재 문제**:
- `any` 타입 다수 사용
- 런타임 에러 위험

**개선 목표**:
- 명시적 인터페이스 정의
- `any` 타입 제거

**구현 파일**:
| 파일 | 작업 |
|------|------|
| `src/types/api.ts` | 신규 - API 응답 타입 |
| `src/app/(dashboard)/**/*.tsx` | 수정 - 타입 적용 |

### 4.3 전역 상태 관리

**현재 문제**:
- 각 페이지에서 개별 `useState`
- 상태 공유 어려움

**개선 목표**:
- Zustand 도입
- 계정/필터 상태 전역 관리

**구현 파일**:
| 파일 | 작업 |
|------|------|
| `package.json` | 수정 - zustand 추가 |
| `src/stores/*.ts` | 신규 - 스토어 정의 |

---

## Phase 5: 코드 품질 개선 (LOW)

### 5.1 중복 코드 통합

**현재 문제**:
- `calculateChange()` 3곳 중복
- 유지보수 어려움

**개선 목표**:
- `src/lib/utils.ts`로 통합
- 단일 소스

**구현 파일**:
| 파일 | 작업 |
|------|------|
| `src/lib/utils.ts` | 수정 - 함수 추가 |
| `src/lib/ai/modules/*.ts` | 수정 - import 변경 |
| `src/components/dashboard/*.tsx` | 수정 - import 변경 |

### 5.2 하드코딩 값 설정화

**현재 문제**:
- ROAS 계산에 `50000` 하드코딩
- 벤치마크 값 고정

**개선 목표**:
- 환경 변수 또는 계정 설정으로 이동
- 동적 벤치마크 계산

**구현 파일**:
| 파일 | 작업 |
|------|------|
| `src/lib/config.ts` | 신규 - 설정 관리 |
| `src/lib/analytics/*.ts` | 수정 - 설정 참조 |

### 5.3 단위 테스트 추가

**현재 문제**:
- 알고리즘 테스트 부재
- 회귀 방지 어려움

**개선 목표**:
- 핵심 알고리즘 테스트 커버리지 80%

**구현 파일**:
| 파일 | 작업 |
|------|------|
| `src/lib/analytics/__tests__/*.test.ts` | 신규 - 테스트 |
| `jest.config.js` | 수정 - 설정 |

---

## 구현 순서

```
Phase 1: API 보안 강화 (Week 1)
├── 1.1 입력 검증 미들웨어
├── 1.2 인증 미들웨어
└── 1.3 Rate Limiting
         │
         ▼
Phase 2: AI 비용 최적화 (Week 1-2)
├── 2.1 프롬프트 템플릿 통합
├── 2.2 모델 선택 최적화
├── 2.3 AI 응답 캐싱
└── 2.4 Fallback 로직 활성화
         │
         ▼
Phase 3: DB 성능 최적화 (Week 2)
├── 3.1 복합 인덱스 추가
├── 3.2 토큰 암호화
└── 3.3 소프트 삭제 구현
         │
         ▼
Phase 4: 프론트엔드 개선 (Week 2-3)
├── 4.1 중복 API 호출 제거
├── 4.2 타입 안전성 강화
└── 4.3 전역 상태 관리
         │
         ▼
Phase 5: 코드 품질 개선 (Week 3)
├── 5.1 중복 코드 통합
├── 5.2 하드코딩 값 설정화
└── 5.3 단위 테스트 추가
```

---

## 예상 효과

| 항목 | Before | After | 개선율 |
|------|:------:|:-----:|:------:|
| 품질 점수 | 72 | 90 | +25% |
| AI 비용 | 100% | 50% | -50% |
| API 응답 속도 | 100% | 70% | -30% |
| 보안 수준 | 50 | 90 | +80% |
| 코드 중복 | 15% | 3% | -80% |

---

## 성공 기준

- [ ] API 입력 검증 100% 적용
- [ ] AI 비용 40% 이상 절감
- [ ] DB 쿼리 성능 50% 이상 개선
- [ ] `any` 타입 0개
- [ ] 핵심 알고리즘 테스트 커버리지 80%
- [ ] 품질 점수 90점 이상

---

## 위험 요소

| 위험 | 영향도 | 대응 방안 |
|------|:------:|----------|
| 마이그레이션 실패 | HIGH | 스테이징 환경 선 테스트 |
| AI 캐싱 무효화 문제 | MEDIUM | 캐시 TTL 적절히 설정 |
| 기존 기능 회귀 | MEDIUM | 단계별 배포 및 모니터링 |

---

## 다음 단계

1. `/pdca design system-improvement-v1` - 상세 설계
2. Phase별 구현
3. 단계별 Gap 분석 및 검증
